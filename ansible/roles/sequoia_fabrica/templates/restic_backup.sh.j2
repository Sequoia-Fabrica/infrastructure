#!/bin/sh
# Restic backup script for {{ restic_config.repository_name }}
# Generated by Ansible - do not edit manually

set -e

TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
LOG_PREFIX="[${TIMESTAMP}]"

log() {
    echo "${LOG_PREFIX} $1"
}

log_error() {
    echo "${LOG_PREFIX} ERROR: $1" >&2
}

log "============================================"
log "Restic Backup: {{ restic_config.repository_name }}"
log "============================================"
log "Repository: ${RESTIC_REPOSITORY}"
log "Sources: {% for idx in range(restic_config.source_paths | length) %}/data/backup{{ idx }}{% if not loop.last %}, {% endif %}{% endfor %}"
log "Retention: ${RETENTION_DAYS} days, ${RETENTION_WEEKS} weeks, ${RETENTION_MONTHS} months"
log ""

# Run backup
log "Starting backup..."
if restic backup {% for idx in range(restic_config.source_paths | length) %}/data/backup{{ idx }} {% endfor %}--verbose; then
    log "Backup completed successfully"
else
    log_error "Backup failed"
    exit 1
fi

log ""

# Apply retention policy
log "Applying retention policy..."
if restic forget \
    --keep-daily "${RETENTION_DAYS}" \
    --keep-weekly "${RETENTION_WEEKS}" \
    --keep-monthly "${RETENTION_MONTHS}" \
    --prune; then
    log "Retention policy applied successfully"
else
    log_error "Failed to apply retention policy"
    exit 1
fi

log ""

# Show repository stats
log "Repository statistics:"
restic stats --mode raw-data

log ""
log "============================================"
log "Backup complete!"
log "============================================"