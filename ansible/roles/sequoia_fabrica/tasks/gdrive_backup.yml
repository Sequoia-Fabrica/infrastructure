---
# Google Drive Backup deployment
# Clones https://github.com/Sequoia-Fabrica/rclone-gdrive-backups and deploys a backup container
#
# Required variables (set in group_vars or vault):
#   gdrive_backup.rclone_token - OAuth token from rclone config (use vault!)
#
# Database sources (at least one required):
#   gdrive_backup.db_path  - Single database file
#   gdrive_backup.db_paths - Colon-separated list of database files
#   gdrive_backup.db_dirs  - Colon-separated list of directories to scan
#
# Optional:
#   gdrive_backup.db_pattern - Pattern for DB_DIRS scanning (default: *.sqlite)

- name: Ensure gdrive_backup is configured
  ansible.builtin.assert:
    that:
      - gdrive_backup is defined
      - gdrive_backup.rclone_token is defined
      - (gdrive_backup.db_path is defined) or (gdrive_backup.db_paths is defined) or (gdrive_backup.db_dirs is defined)
    fail_msg: "gdrive_backup requires rclone_token and at least one of: db_path, db_paths, or db_dirs"

- name: Clone rclone-gdrive-backups repository
  become: true
  ansible.builtin.git:
    repo: https://github.com/Sequoia-Fabrica/rclone-gdrive-backups.git
    dest: /opt/gdrive-backup
    version: "{{ gdrive_backup.repo_version | default('main') }}"
    force: true
  register: gdrive_backup_repo

- name: Template rclone configuration
  become: true
  ansible.builtin.template:
    src: gdrive_backup.rclone.conf.j2
    dest: /opt/gdrive-backup/rclone.conf
    mode: "0600"
  no_log: true
  register: gdrive_backup_rclone_config

- name: Build gdrive-backup Docker image
  become: true
  community.docker.docker_image:
    name: sqlite-gdrive-backup
    tag: latest
    source: build
    build:
      path: /opt/gdrive-backup
    force_source: "{{ gdrive_backup_repo.changed }}"
    state: present

- name: Build volume mounts list
  ansible.builtin.set_fact:
    gdrive_backup_volumes: >-
      {{
        ['/opt/gdrive-backup/rclone.conf:/etc/rclone/rclone.conf']
        + (gdrive_backup.volumes | default([]))
      }}

- name: Build environment variables
  ansible.builtin.set_fact:
    gdrive_backup_env:
      RCLONE_REMOTE_NAME: "{{ gdrive_backup.rclone_remote_name | default('gdrive') }}"
      DRIVE_FOLDER_NAME: "{{ gdrive_backup.drive_folder_name | default('sqlite_backups') }}"
      BACKUP_SCHEDULE: "{{ gdrive_backup.backup_schedule | default('30 2 * * *') }}"
      RUN_ON_STARTUP: "{{ gdrive_backup.run_on_startup | default(false) | string | lower }}"
      RCLONE_CONFIG_DIR: "/etc/rclone"
      RETENTION_DAYS: "{{ gdrive_backup.retention_days | default(30) | string }}"

- name: Add DB_PATH to environment if defined
  ansible.builtin.set_fact:
    gdrive_backup_env: "{{ gdrive_backup_env | combine({'DB_PATH': gdrive_backup.db_path}) }}"
  when: gdrive_backup.db_path is defined

- name: Add DB_PATHS to environment if defined
  ansible.builtin.set_fact:
    gdrive_backup_env: "{{ gdrive_backup_env | combine({'DB_PATHS': gdrive_backup.db_paths}) }}"
  when: gdrive_backup.db_paths is defined

- name: Add DB_DIRS to environment if defined
  ansible.builtin.set_fact:
    gdrive_backup_env: "{{ gdrive_backup_env | combine({'DB_DIRS': gdrive_backup.db_dirs}) }}"
  when: gdrive_backup.db_dirs is defined

- name: Add DB_PATTERN to environment if defined
  ansible.builtin.set_fact:
    gdrive_backup_env: "{{ gdrive_backup_env | combine({'DB_PATTERN': gdrive_backup.db_pattern}) }}"
  when: gdrive_backup.db_pattern is defined

- name: Deploy gdrive-backup container
  become: true
  community.docker.docker_container:
    name: "{{ gdrive_backup.container_name | default('gdrive_backup') }}"
    image: sqlite-gdrive-backup:latest
    state: started
    restart_policy: unless-stopped
    recreate: "{{ gdrive_backup_repo.changed or gdrive_backup_rclone_config.changed }}"
    env: "{{ gdrive_backup_env }}"
    volumes: "{{ gdrive_backup_volumes }}"
    log_driver: json-file
    log_options:
      max-size: "10m"
      max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "cron"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 5s
