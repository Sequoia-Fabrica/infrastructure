{$DOMAIN:multipass.sequoia.garden} {
    # Reverse proxy to multipass application
    reverse_proxy multipass:3000

    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        
        # XSS protection
        X-XSS-Protection "1; mode=block"
        
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'"
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/multipass.log
        format json
        level INFO
    }

    # Handle errors gracefully
    handle_errors {
        @404 expression {http.error.status_code} == 404
        handle @404 {
            respond "Page not found" 404
        }
        
        @5xx expression {http.error.status_code} >= 500
        handle @5xx {
            respond "Internal server error" 500
        }
    }
}

# Health check endpoint (optional, for load balancers)
health.{$DOMAIN:multipass.sequoia.garden} {
    reverse_proxy multipass:3000/health
    
    header {
        Cache-Control "no-cache, no-store, must-revalidate"
    }
}
